const {sqlite, query} = require('../database/db');

const chatGame = {}
const messages = {
    gameStarted: '–ò–≥—Ä–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞',
    notLeader: '–í—ã –Ω–µ –≤–µ–¥—É—â–∏–π. –î–æ–∂–¥–∏—Ç–µ—Å—å —Å–≤–æ–µ–π –æ—á–µ—Ä–µ–¥–∏.',
    noGame: '–ò–≥—Ä–∞ –µ—â—ë –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /startAlias –¥–ª—è –Ω–∞—á–∞–ª–∞.',
    endGame: '–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /startAlias –¥–ª—è –Ω–∞—á–∞–ª–∞.',
};

function aliasStart(bot) {
    // –°—Ç–∞—Ä—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞
    bot.onText(/^\/startAlias/gi, (msg) => {
        if (msg.chat.type === 'group' || msg.chat.type === 'supergroup') {
            const {chat: {id: chat_id}} = msg;

            if (!chatGame[chat_id]) {
                chatGame[chat_id] = {gameOn: false, currentLeader: null, currentWord: ''};
            }

            if (!chatGame[chat_id].gameOn) {
                chatGame[chat_id].gameOn = true;
                bot.sendMessage(chat_id, '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã —Å—Ç–∞—Ç—å –≤–µ–¥—É—â–∏–º.', {
                    reply_markup: {
                        inline_keyboard: [[{
                            text: '–°—Ç–∞—Ç—å –≤–µ–¥—É—â–∏–º',
                            callback_data: `become_leader_${chat_id}`
                        }]]
                    }
                });
            } else {
                bot.sendMessage(chat_id, messages.gameStarted);
            }
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏
    bot.on('callback_query', (callbackQuery) => {
        const {id, message: {message_id, chat: {id: chat_id}}, from: {id: user_id}, data} = callbackQuery;
        const gameState = chatGame[chat_id];

        if (!gameState || !gameState.gameOn) return;

        switch (data) {
            case `become_leader_${chat_id}`:
                if (!gameState.currentLeader) {
                    gameState.currentLeader = user_id;
                    gameState.currentWord = getRandomWord();
                    bot.answerCallbackQuery(id, {
                        text: `–í–∞—à–µ —Å–ª–æ–≤–æ: ${gameState.currentWord}`,
                        show_alert: true
                    });
                    bot.sendMessage(chat_id, `–í–µ–¥—É—â–∏–º –Ω–∞–∑–Ω–∞—á–µ–Ω ${callbackQuery.from.first_name}`, {
                        reply_markup: {
                            inline_keyboard: [[{
                                text: '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ª–æ–≤–æ',
                                callback_data: `become_leader_${chat_id}`
                            }]]
                        }
                    });
                    bot.deleteMessage(chat_id, message_id);
                    return;
                }

                if (gameState.currentLeader === user_id) {
                    bot.answerCallbackQuery(id, {
                        text: `–í–∞—à–µ —Å–ª–æ–≤–æ: ${gameState.currentWord}`,
                        show_alert: true
                    });
                } else {
                    bot.answerCallbackQuery(id, {
                        text: messages.notLeader,
                        show_alert: true
                    });
                }
                break;
            case `like_word_${chat_id}`:
                updateWordRating(gameState.currentWord, 1);
                bot.answerCallbackQuery(id, {text: '–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ü–µ–Ω–∫—É!'});
                bot.editMessageReplyMarkup({
                    inline_keyboard: [[{
                        text: '–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥',
                        callback_data: `become_leader_${chat_id}`
                    }]]
                }, {chat_id, message_id});
                break;
            case `dislike_word_${chat_id}`:
                updateWordRating(gameState.currentWord, -1);
                bot.answerCallbackQuery(id, {text: '–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ü–µ–Ω–∫—É!'});
                bot.editMessageReplyMarkup({
                    inline_keyboard: [[{
                        text: '–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥',
                        callback_data: `become_leader_${chat_id}`
                    }]]
                }, {chat_id, message_id});
                break;
            default:
                bot.answerCallbackQuery(id, {text: '–ù–µ–≤–µ—Ä–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.'});
                break;
        }
    });

    // –ü—Ä–æ—Å–ª—É—à–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –≤–µ—Ä–Ω—É–π –æ—Ç–≤–µ—Ç
    bot.on('message', (msg) => {
        if ('text' in msg) {
            const {from: {id: user_id, first_name}, chat: {id: chat_id}, text} = msg;
            const gameState = chatGame[chat_id];
            if (!gameState) return;
            const guess = isWordInMessage(gameState.currentWord.toLowerCase(), text)

            if (guess) {
                if (gameState.currentLeader !== user_id) {
                    //–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–∏–ª –Ω–µ –≤–µ–¥—É—â–∏–π –∏ —Å–ª–æ–≤–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ
                    bot.sendMessage(chat_id, `–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, ${first_name} —É–≥–∞–¥–∞–ª —Å–ª–æ–≤–æ!`, {
                        reply_markup: {
                            inline_keyboard: [[{
                                text: '–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥',
                                callback_data: `become_leader_${chat_id}`
                            }],
                                [{
                                    text: 'üëç —ç—Ç–æ–º—É —Å–ª–æ–≤—É',
                                    callback_data: `like_word_${chat_id}`
                                }, {
                                    text: `üëé —ç—Ç–æ–º—É —Å–ª–æ–≤—É`,
                                    callback_data: `dislike_word_${chat_id}`
                                }]]
                        }
                    });
                    giveCoins(gameState.currentLeader, 10);
                    gameState.currentLeader = null;
                    addRating(chat_id, user_id, first_name, gameState);
                    giveCoins(user_id, 10);
                } else if (gameState.currentLeader === user_id) {
                    // –ï—Å–ª–∏ –≤–µ–¥—É—â–∏–π –Ω–∞–∑–≤–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ
                    bot.sendMessage(chat_id, `${first_name}, –≤—ã –Ω–µ –¥–æ–ª–∂–Ω—ã –ø–∏—Å–∞—Ç—å —Å–ª–æ–≤–æ. –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ —à—Ç—Ä–∞—Ñ.`);
                    takeCoins(user_id, 20);
                    aliasEnd(bot, chat_id);
                }
            }
        }
    });
}

function aliasEnd(bot, chatId = null) {
    if (chatId) {
        chatGame[chatId] = null
        bot.sendMessage(chatId, messages.noGame);
    }
    else {
        bot.onText(/^\/endAlias/gi, (msg) => {
            const {chat: {id}} = msg;
            if (chatGame[id] && chatGame[id].gameOn) {
                chatGame[id] = null

                bot.sendMessage(id, messages.endGame);
            }
        });
    }
}

function aliasRating(bot) {
    bot.onText(/^\/ratingAlias/gi, (msg) => {
        const {chat: {id: chat_id}} = msg;

        bot.sendMessage(chat_id, getUserRatings(chat_id), {parse_mode: 'html'});
    });
}

function getRandomWord() {
    // –í—ã–ø–æ–ª–Ω—è–µ–º SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–ª–æ–≤–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã words
    const result = query("SELECT word FROM words ORDER BY RANDOM() LIMIT 1;");
    return result.length > 0 ? result[0].word : null;
}

function giveCoins(userId, x) {
    // –õ–æ–≥–∏–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –º–æ–Ω–µ—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    const result = query('SELECT `user_coins` FROM users WHERE `user_id` = ?', [userId])[0].user_coins;
    let update_coins = result + x;
    query("UPDATE users SET `user_coins` = ? WHERE `user_id` = ?", [update_coins, userId]);
}

function takeCoins(userId, x) {
    // –õ–æ–≥–∏–∫–∞ —Å–Ω—è—Ç–∏—è –º–æ–Ω–µ—Ç–æ–∫ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const result = query('SELECT `user_coins` FROM users WHERE `user_id` = ?', [userId])[0].user_coins;
    let update_coins = result - x;
    query("UPDATE users SET `user_coins` = ? WHERE `user_id` = ?", [update_coins, userId]);
}

function addRating(chatId, userId, userName, gameState) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ç–µ–∫—É—â–µ–º —á–∞—Ç–µ
    const userInChat = isUserInChatRating(chatId, userId);

    if (userInChat.length > 0) {
        updateWordRating(gameState.currentWord, 1);
    } else {
        const userInOtherChat = query("SELECT * FROM words_top WHERE user_id = ?", [userId]);

        if (userInOtherChat.length > 0) {
            query("INSERT INTO words_top (chat_id, user_id, user_name, rating) VALUES (?, ?, ?, 1)", [chatId, userId, userName]);
        } else {
            query("INSERT INTO words_top (chat_id, user_id, user_name, rating) VALUES (?, ?, ?, 1)", [chatId, userId, userName]);
        }
    }
}

function updateWordRating(word, ratingChange) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–ª–æ–≤–æ –≤ —Ç–∞–±–ª–∏—Ü–µ words_ratings
    const existingWord = query("SELECT * FROM words_ratings WHERE word = ?", [word]);

    if (existingWord.length > 0) {
        // –ï—Å–ª–∏ —Å–ª–æ–≤–æ –µ—Å—Ç—å, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥
        if (ratingChange > 0) {
            query("UPDATE words_ratings SET likes = likes + ? WHERE word = ?", [1, word]);
        } else {
            query("UPDATE words_ratings SET dislikes = dislikes + ? WHERE word = ?", [1, word]);
        }
    } else {
        // –ï—Å–ª–∏ —Å–ª–æ–≤–∞ –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ —Å –Ω–∞—á–∞–ª—å–Ω—ã–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º
        query("INSERT INTO words_ratings (word, likes, dislikes) VALUES (?, ?, ?)", [word, 0, 0]);
    }
}

function isUserInChatRating(chatId, userId) {
    return query("SELECT * FROM words_top WHERE chat_id = ? AND user_id = ?", [chatId, userId]);
}

function getUserRatings(chatId) {
    const result = query(`SELECT user_name, rating
                          FROM words_top
                          WHERE chat_id = ?
                          ORDER BY rating DESC LIMIT 10`, [chatId]);

    if (result.length > 0) {
        let message = '–†–µ–π—Ç–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–∞—Ç–∞:\n\n';

        let result_message = result.reduce((acc, user) => {
            acc += `${user.user_name} - ${user.rating}\n`;
            return acc;
        }, '');

        return message + result_message;
    } else {
        return '–í —ç—Ç–æ–º —á–∞—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º.';
    }
}

function isWordInMessage(word, message) {
    const escapeRegex = (str) => str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(`(^|\\W)${escapeRegex(word)}(\\W|$)`, 'gim');
    return regex.test(message);
}


module.exports = {aliasStart, aliasEnd, aliasRating}